<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Charge</title>

  <style>
    #pay-popup, #refund-popup, #result-popup {
      align: auto;
      height: 200px;
      width: 200px;
      position: absolute;
      top: 200px;
      left: 200px;
      background: white;
      border: double black;
      padding: 20px;
    }
  </style>

</head>
<body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.js"></script>

<script type="text/javascript" src="https://dev.rdbhost.com/vendor/labjs/LAB.js"></script>
<script>
  var $L = $LAB
      .script('/V2/rdb2js/lib/js/rdb2-bundle.js').wait(
          function () {
            if (!Rdbhost.featuredetects.hasPromises())
              $L = $L.script('/V2/rdb2js/vendor/es6-promises/dist/es6-promise.js');
            if (!Rdbhost.featuredetects.hasFetch())
              $L = $L.script('/V2/rdb2js/vendor/fetch/fetch.js').wait();
          }
      );
  $L = $L.script('/V2/rdb2js/lib/js/rdb2-livereload.js')
      .script('/V2/rdb2js/lib/js/rdb2-charge.js');
</script>

<h3>Simplified order Form, for Credit-card operations.</h3>

<h4>Test Card Numbers</h4>
<p>The Stripe.Com account used here is a test account, so only test card numbers can be used.
Use one of these, or see a more complete list at <a href="https://stripe.com/docs/testing#cards">Stripe</a>.
  Use a future expiration date for success, past for failure.</p>
<h5>Good Numbers</h5>
<ul>
  <li>4242 4242 4242 4242</li>
  <li>5555 5555 5555 4444</li>
</ul>
<h5>Bad Numbers</h5>
<ul>
  <li>4000 0000 0000 0101</li>
  <li>4000 0000 0000 0002</li>
</ul>

<section>
  <h4>Unpaid orders</h4>

  <table id="unpaid" rules="all" frame="box" hidden>
    <thead>
    <tr>
      <th>id</th>
      <th>items</th>
      <th>price</th>
      <th>-</th>
    </tr>
    </thead>

    <tbody>
    <tr>
      <td>{{id}}</td>
      <td>{{desc}}</td>
      <td>{{price}}</td>
      <td>
        <button class="pay">Pay</button>
      </td>
    </tr>
    </tbody>
  </table>

</section>

<p></p>
<section>
  <button id="new-order">Create New Order</button>
</section>

<section>
  <h4>Paid Orders</h4>

  <table id="paid" rules="all" frame="box" hidden>
    <thead>
    <tr>
      <th>id</th>
      <th>items</th>
      <th>price</th>
      <th>confirm code</th>
      <th>-</th>
    </tr>
    </thead>

    <tbody>
    <tr>
      <td>{{id}}</td>
      <td>{{desc}}</td>
      <td>{{price}}</td>
      <td>{{confirm}}</td>
      <td>
        <button class="refund">Refund</button>
      </td>
    </tr>
    </tbody>
  </table>

</section>

<div style="display:none" id="pay-popup" frame="box">
  <h4>Pay for Order</h4>
  <button id="close-pay">[x]</button><br/>

  Order: <span class="order-num"></span><br/>
  Price: $<span class="price"></span>
  <input id="price" name="price" type="hidden">
  <input id="order-num" name="order-num" type="hidden"><br/>

  <span class="pay-error-msg"></span>

  <input id="cc_num" name="cc_num" size="20"><br/>
  <input id="cc_mon" name="cc_mon" size="2">
  <input id="cc_yr" name="cc_yr" size="2">
  <input id="cc_cvc" name="cc_cvc" size="3"><br/>

  <button id="pay-order">Pay for Order</button>
</div>
<div style="display:none" id="refund-popup" frame="box">
  <h4>Refund Charge</h4>
  <button id="close-refund">[x]</button><br/>

  Amount: $<span class="price"></span>
  <input id="refund-amt" name="refund-amt" type="hidden"><br/>

  <span class="refund-error-msg"></span>
  <input id="confirm-code" name="confirm-code" size="20"><br/>

  <button id="refund-charge">Refund the Charge</button>
</div>
<div style="display:none" id="result-popup" frame="box">
  <h4>Result</h4>
  <button id="close-result">[x]</button><br/>

  <span class="message"></span>
</div>


<script>
  $L = $L.wait(function () {

    Rdbhost.connect('dev.rdbhost.com', 14);
    var preauthRef = Rdbhost.preauth();
    Rdbhost.activate_reloader(preauthRef.clone());

    $(document).on('click', '.pay', function(evt) {

      var $idTd = $(evt.target).closest('tr').find('td').first(),
          order_id = $idTd.text(),
          $priceTd = $(evt.target).closest('tr').find('td:nth-child(3)'),
          price = $priceTd.text();

      $('#pay-popup .order-num').text(order_id);
      $('#pay-popup .pay-error-msg').text();
      $('#pay-popup .price').text(price);
      $('#price').val(price);
      $('#order-num').val(order_id);
      $('#cc_num').val('');
      $('#cc_yr').val('');
      $('#cc_mon').val('');
      $('#cc_cvc').val('');

      $('#pay-popup').show();
    });
    $('#close-pay').click(function(evt) {
      $('#pay-popup').hide();
    });
    $('#pay-order').click(function(evt) {

      var price = $('#price').val(),
          order_id = $('#order-num').val(),
          cc_num = $('#cc_num').val(),
          cc_exp_mon = $('#cc_mon').val(),
          cc_exp_yr = $('#cc_yr').val(),
          cc_cvc = $('#cc_cvc').val();

      if ( !cc_num || !cc_exp_mon || !cc_exp_yr || !cc_cvc )
        return;

      var preauth = Rdbhost.Charge.preauth();
      var pr = preauth
          .query("SELECT id AS idx, (price*100)::INT AS amount, items AS description \
        FROM orders WHERE id = %(order)s")
          .params({'order': order_id})
          .charge(cc_num, cc_cvc, cc_exp_mon, cc_exp_yr);

      pr.then(function (d) {
            $('#pay-popup').hide();
            var res = d.result_sets[0].rows[0].result;
            $('#result-popup .message').text(res);
            $('#result-popup').show();
            load_orders();
          })
          .catch(function(e) {
            $('#pay-popup .pay-error-msg').text(e.message);
          });
    });

    $(document).on('click', '.refund', function(evt) {

      var $confirmTd = $(evt.target).closest('tr').find('td:nth-child(4)').first(),
          confirmCode = $confirmTd.text(),
          $priceTd = $(evt.target).closest('tr').find('td:nth-child(3)'),
          price = $priceTd.text();

      $('#refund-popup .pay-error-msg').text('');
      $('#refund-popup .price').text(price);
      $('#refund-amt').val(price);
      $('#confirm-code').val(confirmCode);

      $('#refund-popup').show();
    });
    $('#close-refund').click(function(evt) {
      $('#refund-popup').hide();
    });
    $('#refund-charge').click(function(evt) {

      var price = $('#price').val(),
          confirm_code = $('#confirm-code').val();

      var preauth = Rdbhost.Charge.preauth();
      var pr = preauth
          .query("SELECT c.idx AS idx, c.id AS id, c.amount AS amount \
        FROM charges c WHERE id = %(confirm_code)s")
          .params({'confirm_code': confirm_code})
          .refund();

      pr.then(function (d) {
            $('#refund-popup').hide();
            var res = d.result_sets[0].rows;
            if ( !res )
              $('#result-popup .message').text('Charge not found');
            else
              $('#result-popup .message').text(res);
            $('#result-popup').show();
            load_orders();
          })
          .catch(function(e) {
            $('#refund-popup .pay-error-msg').text(e.message);
          });
    });

    $('#new-order').click(function() {

      var q = 'INSERT INTO orders (items, price) SELECT "desc", price FROM order_elements ORDER BY random() LIMIT 1;';
      var preauth = preauthRef.clone(),
          pr = preauth.query(q).get_data();
      pr.then(function(d) {
        load_orders();
      });
    });
    $('#close-result').click(function(evt) {
      $('#result-popup').hide();
    });


    function prep_table(id) {

      var $tbl = $('#' + id),
          $th = $tbl.find('tr').first().remove(),
          $tr = $tbl.find('tr').first();
      return {
        '$table': $tbl,
        '$th': $th,
        'tpl': $tr[0].outerHTML
      }
    }

    var unPaidTblData = prep_table('unpaid');
    var paidTblData = prep_table('paid');

    function load_orders() {

      var q =  'SELECT o.id, o.items, o.price \n' +
               '  FROM orders o LEFT JOIN unrefunded_charges c ON (o.id::VARCHAR = c.idx)\n' +
               ' WHERE (c.paid IS NULL OR NOT c.paid);\n' +
               'SELECT o.id, o.items, o.price, c.id AS confirm \n' +
               '  FROM orders o JOIN unrefunded_charges c ON (o.id::VARCHAR = c.idx AND c.paid);\n';

      var preauth = preauthRef.clone(),
          pr = preauth.query(q).get_data();

      pr.then(function (d) {

        var unpaid = d.result_sets[0].records,
            paid = d.result_sets[1].records,
            row, up, p;

        // populate unpaid-orders html table
        //
        unPaidTblData.$table.empty();
        unPaidTblData.$table.append(unPaidTblData.$th);

        for (var _up in unpaid.rows) {
          if (!unpaid.rows.hasOwnProperty(_up))
            continue;
          up = unpaid.rows[_up];
          row = unPaidTblData.tpl.replace('{{id}}', up.id).replace('{{desc}}', up.items)
              .replace('{{price}}', up.price);
          unPaidTblData.$table.append(row);
        }
        unPaidTblData.$table.show();

        // populate paid-orders html table
        //
        paidTblData.$table.empty();
        paidTblData.$table.append(paidTblData.$th);

        for (var _p in paid.rows) {
          if (!paid.rows.hasOwnProperty(_p))
            continue;
          p = paid.rows[_p];
          row = paidTblData.tpl.replace('{{id}}', p.id).replace('{{desc}}', p.items)
              .replace('{{price}}', p.price).replace('{{confirm}}', p.confirm);
          paidTblData.$table.append(row);
        }
        paidTblData.$table.show();

      })
      .catch(function (e) {
        debugger;
      })

    }

    load_orders();
  });
</script>
</body>
</html>